<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³é˜¡å¿å¦‡å¹¼ä¿å¥é™¢OKRç®¡ç†ç³»ç»Ÿ v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 400px;
            max-width: 90%;
        }

        .login-box h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .login-box .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-box .form-group {
            margin-bottom: 20px;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .login-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-box .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-top: 10px;
        }

        .login-box .help-text {
            text-align: center;
            margin-top: 20px;
            color: #999;
            font-size: 12px;
        }

        .login-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 10px;
        }

        .login-actions a {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
            transition: color 0.3s;
        }

        .login-actions a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        /* ä¸»ç•Œé¢å®¹å™¨ - é»˜è®¤éšè— */
        .main-container {
            display: none;
        }

        .main-container.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            padding: 0 20px;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-item:hover {
            background: #e9ecef;
        }

        .nav-item.active {
            border-bottom-color: #667eea;
            color: #667eea;
            background: white;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .level-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .level-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .level-btn:hover {
            border-color: #667eea;
        }

        .level-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .level-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-btn h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .level-btn p {
            font-size: 12px;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .okr-pair {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .okr-pair.valid {
            border-color: #28a745;
            background: #f0fff4;
        }

        .okr-pair.invalid {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .okr-pair.warning {
            border-color: #ffc107;
            background: #fffbf0;
        }

        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pair-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .validation-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .validation-status.valid {
            color: #28a745;
        }

        .validation-status.invalid {
            color: #dc3545;
        }

        .validation-status.warning {
            color: #ffc107;
        }

        .feedback-box {
            background: white;
            border-left: 4px solid;
            padding: 12px 15px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 13px;
        }

        .feedback-box.valid {
            border-color: #28a745;
            background: #d4edda;
        }

        .feedback-box.invalid {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .feedback-box.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .feedback-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .feedback-list {
            list-style: none;
            padding-left: 0;
        }

        .feedback-list li {
            padding: 3px 0;
            position: relative;
            padding-left: 20px;
        }

        .feedback-list li:before {
            content: "â€¢";
            position: absolute;
            left: 5px;
            font-weight: bold;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .real-time-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            animation: pulse 2s infinite;
            z-index: 1000;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .department-select, .person-select {
            display: none;
        }

        .department-select.active, .person-select.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .close-modal {
            float: right;
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .template-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .template-card .okr-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .okr-tree {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .tree-node {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .tree-node.level-unit {
            border-left: 4px solid #667eea;
        }

        .tree-node.level-dept {
            border-left: 4px solid #28a745;
            margin-left: 20px;
        }

        .tree-node.level-person {
            border-left: 4px solid #ffc107;
            margin-left: 40px;
        }

        .tree-node h4 {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .tree-node .tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #e9ecef;
        }

        .or-item {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .k-item {
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 6px;
            margin-left: 15px;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div class="login-container" id="login-container">
        <div class="login-box">
            <h2>ğŸ¥ çŸ³é˜¡å¿å¦‡å¹¼ä¿å¥é™¢</h2>
            <p class="subtitle">OKRç®¡ç†ç³»ç»Ÿ v2.0</p>
            <form onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <label>å·¥å·</label>
                    <input type="text" id="login-id" placeholder="è¯·è¾“å…¥å·¥å·" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">ç™»å½•</button>
            </form>
            <div class="login-actions">
                <a href="#" onclick="event.preventDefault(); showChangePasswordModal();">ä¿®æ”¹å¯†ç </a>
                <a href="#" onclick="event.preventDefault(); showForgotPasswordModal();">å¿˜è®°å¯†ç ï¼Ÿ</a>
            </div>
            <p class="help-text">ç®¡ç†å‘˜ï¼šadmin / admin123<br>æ™®é€šç”¨æˆ·ï¼šå·¥å· / 123456</p>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="change-password-modal">
        <div class="modal-content login-box">
            <span class="close-modal" onclick="closeModal('change-password-modal')">&times;</span>
            <h3>ğŸ” ä¿®æ”¹å¯†ç </h3>
            <form onsubmit="event.preventDefault(); handleChangePassword();">
                <div class="form-group">
                    <label>å·¥å·</label>
                    <input type="text" id="change-id" placeholder="è¯·è¾“å…¥å·¥å·" required>
                </div>
                <div class="form-group">
                    <label>åŸå¯†ç </label>
                    <input type="password" id="change-old-password" placeholder="è¯·è¾“å…¥åŸå¯†ç " required>
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="change-new-password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="change-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">ç¡®è®¤ä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <!-- æ‰¾å›å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="forgot-password-modal">
        <div class="modal-content login-box">
            <span class="close-modal" onclick="closeModal('forgot-password-modal')">&times;</span>
            <h3>ğŸ” æ‰¾å›å¯†ç </h3>
            <p class="subtitle">è¯·è¾“å…¥å·¥å·å’Œå§“åéªŒè¯èº«ä»½</p>
            <form onsubmit="event.preventDefault(); handleForgotPassword();">
                <div class="form-group">
                    <label>å·¥å·</label>
                    <input type="text" id="forgot-id" placeholder="è¯·è¾“å…¥å·¥å·" required>
                </div>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="forgot-name" placeholder="è¯·è¾“å…¥çœŸå®å§“å" required>
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="forgot-new-password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="forgot-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">é‡ç½®å¯†ç </button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢å®¹å™¨ -->
    <div class="main-container" id="main-container">
        <div class="real-time-indicator">âœ“ å®æ—¶æ ¡éªŒå¼€å¯</div>

        <div class="container">
            <div class="header">
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                <h1>çŸ³é˜¡å¿å¦‡å¹¼ä¿å¥é™¢OKRç®¡ç†ç³»ç»Ÿ</h1>
                <p id="welcome-message">ç›®æ ‡(Objectives)ä¸å…³é”®ç»“æœ(Key Results)æ™ºèƒ½æ‹Ÿå®šä¸æ ¡éªŒå¹³å°</p>
            </div>

            <div class="nav">
                <div class="nav-item active" data-section="create">OKRæ‹Ÿå®š</div>
                <div class="nav-item" data-section="users">ç”¨æˆ·ç®¡ç†</div>
                <div class="nav-item" data-section="templates">æ¨¡æ¿åº“</div>
                <div class="nav-item" data-section="tree">ç›®æ ‡æ ‘</div>
                <div class="nav-item" data-section="stats">ç»Ÿè®¡åˆ†æ</div>
            </div>

            <div class="main-content">
                <!-- OKRæ‹Ÿå®šåŒºåŸŸ -->
                <div class="section active" id="create-section">
                    <div class="level-selector">
                        <div class="level-btn active" data-level="unit">
                            <h3>å•ä½å±‚é¢</h3>
                            <p>çŸ³é˜¡å¿å¦‡å¹¼ä¿å¥é™¢</p>
                        </div>
                        <div class="level-btn" data-level="dept">
                            <h3>ç§‘å®¤å±‚é¢</h3>
                            <p>å„ä¸´åºŠã€åŒ»æŠ€ã€è¡Œæ”¿ç§‘å®¤</p>
                        </div>
                        <div class="level-btn" data-level="person">
                            <h3>ä¸ªäººå±‚é¢</h3>
                            <p>ç§‘å®¤æˆå‘˜</p>
                        </div>
                    </div>

                    <div class="form-group department-select" id="dept-select-group">
                        <label>é€‰æ‹©ç§‘å®¤</label>
                        <select id="department-select">
                            <option value="">è¯·é€‰æ‹©ç§‘å®¤...</option>
                            <option value="unit">é™¢é¢†å¯¼</option>
                            <option value="party-office">å…šå§”åŠã€è¡Œæ”¿åŠ</option>
                            <option value="conduct-office">è¡Œé£åŠ</option>
                            <option value="personnel">äººäº‹ç§‘</option>
                            <option value="finance">è´¢åŠ¡ç§‘</option>
                            <option value="medical-insurance">åŒ»ä¿ç§‘</option>
                            <option value="medical">åŒ»åŠ¡ç§‘</option>
                            <option value="nursing">æŠ¤ç†éƒ¨</option>
                            <option value="infection-control">æ„Ÿæ§ç§‘</option>
                            <option value="pharmacy">è¯å­¦éƒ¨</option>
                            <option value="health-care">ä¿å¥éƒ¨</option>
                            <option value="reform-office">åŒ»æ”¹åŠ</option>
                            <option value="logistics">åå‹¤ä¿éšœç§‘</option>
                        </select>
                    </div>

                    <div class="form-group person-select" id="person-select-group">
                        <label>é€‰æ‹©äººå‘˜</label>
                        <select id="person-select">
                            <option value="">è¯·é€‰æ‹©äººå‘˜...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è€ƒæ ¸å‘¨æœŸ</label>
                        <select id="period-select">
                            <option value="Q1">2026å¹´ç¬¬ä¸€å­£åº¦ (Q1)</option>
                            <option value="Q2">2026å¹´ç¬¬äºŒå­£åº¦ (Q2)</option>
                            <option value="Q3">2026å¹´ç¬¬ä¸‰å­£åº¦ (Q3)</option>
                            <option value="Q4">2026å¹´ç¬¬å››å­£åº¦ (Q4)</option>
                            <option value="year">2026å¹´å…¨å¹´</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addOKRPair()">+ æ·»åŠ OKRç»„åˆ</button>
                        <button class="btn btn-success" onclick="validateAll()">å…¨éƒ¨æ ¡éªŒ</button>
                        <button class="btn btn-warning" onclick="showTemplates()">åº”ç”¨æ¨¡æ¿</button>
                    </div>

                    <div id="okr-container">
                        <!-- OKRç»„åˆå°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="submitOKR()">æäº¤ä¿å­˜</button>
                        <button class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç†åŒºåŸŸ -->
                <div class="section" id="users-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ç”¨æˆ·ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="showAddUserModal()">+ æ·»åŠ ç”¨æˆ·</button>
                    </div>

                    <div class="form-group">
                        <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·å§“åã€ç§‘å®¤ã€å·¥å·..." oninput="filterUsers()">
                    </div>

                    <div class="form-group">
                        <select id="user-dept-filter" onchange="filterUsers()">
                            <option value="">å…¨éƒ¨ç§‘å®¤</option>
                            <option value="unit">é™¢é¢†å¯¼</option>
                            <option value="party-office">å…šå§”åŠã€è¡Œæ”¿åŠ</option>
                            <option value="conduct-office">è¡Œé£åŠ</option>
                            <option value="personnel">äººäº‹ç§‘</option>
                            <option value="finance">è´¢åŠ¡ç§‘</option>
                            <option value="medical-insurance">åŒ»ä¿ç§‘</option>
                            <option value="medical">åŒ»åŠ¡ç§‘</option>
                            <option value="nursing">æŠ¤ç†éƒ¨</option>
                            <option value="infection-control">æ„Ÿæ§ç§‘</option>
                            <option value="pharmacy">è¯å­¦éƒ¨</option>
                            <option value="health-care">ä¿å¥éƒ¨</option>
                            <option value="reform-office">åŒ»æ”¹åŠ</option>
                            <option value="logistics">åå‹¤ä¿éšœç§‘</option>
                        </select>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>å·¥å·</th>
                                <th>å§“å</th>
                                <th>ç§‘å®¤</th>
                                <th>èŒåŠ¡</th>
                                <th>è§’è‰²</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- ç”¨æˆ·æ•°æ®å°†åŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>

                <!-- æ¨¡æ¿åº“åŒºåŸŸ -->
                <div class="section" id="templates-section">
                    <h2>OKRæ¨¡æ¿åº“</h2>
                    <p class="help-text">ç‚¹å‡»æ¨¡æ¿å¯ç›´æ¥åº”ç”¨åˆ°å½“å‰é€‰ä¸­çš„å±‚çº§</p>
                    <div class="template-grid" id="template-container"></div>
                </div>

                <!-- ç›®æ ‡æ ‘åŒºåŸŸ -->
                <div class="section" id="tree-section">
                    <h2>OKRç›®æ ‡æ ‘</h2>
                    <p class="help-text">å±•ç¤ºå•ä½-ç§‘å®¤-ä¸ªäººçš„ç›®æ ‡å¯¹é½å…³ç³»</p>

                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3 id="total-ors">0</h3>
                            <p>æ€»ç›®æ ‡æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="total-ks">0</h3>
                            <p>æ€»å…³é”®ç»“æœæ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="valid-rate">0%</h3>
                            <p>æ ¡éªŒé€šè¿‡ç‡</p>
                        </div>
                    </div>

                    <div class="okr-tree" id="okr-tree">
                        <!-- ç›®æ ‡æ ‘å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç»Ÿè®¡åˆ†æåŒºåŸŸ -->
                <div class="section" id="stats-section">
                    <h2>ç»Ÿè®¡åˆ†æ</h2>

                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3 id="completion-rate">0%</h3>
                            <p>æ•´ä½“å®Œæˆç‡</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="alignment-score">0</h3>
                            <p>ç›®æ ‡å¯¹é½åˆ†æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="quality-score">0</h3>
                            <p>OKRè´¨é‡åˆ†æ•°</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ ¡éªŒé—®é¢˜åˆ†å¸ƒ</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="error-distribution-bar" style="width: 30%"></div>
                        </div>
                        <p class="help-text" id="error-distribution-text">é”™è¯¯ 30% | è­¦å‘Š 70%</p>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <label>ç³»ç»Ÿæ“ä½œ</label>
                        <button class="btn btn-danger" onclick="clearLocalData()">æ¸…é™¤æœ¬åœ°æ•°æ®</button>
                        <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤ºå¼¹çª— -->
    <div class="modal" id="success-modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-modal" onclick="closeModal('success-modal')">&times;</span>
            <div style="font-size: 60px; margin-bottom: 20px;">âœ…</div>
            <h3>OKRæäº¤æˆåŠŸï¼</h3>
            <p>æ‚¨çš„ç›®æ ‡å·²é€šè¿‡åˆç†æ€§æ ¡éªŒï¼Œå·²æˆåŠŸä¿å­˜åˆ°ç³»ç»Ÿã€‚</p>
            <p class="help-text">ç›®æ ‡æ ‘å·²è‡ªåŠ¨æ›´æ–°ï¼Œå¯ä»¥å‰å¾€"ç›®æ ‡æ ‘"é¡µé¢æŸ¥çœ‹</p>
        </div>
    </div>

    <!-- æ·»åŠ ç”¨æˆ·å¼¹çª— -->
    <div class="modal" id="add-user-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('add-user-modal')">&times;</span>
            <h3>æ·»åŠ æ–°ç”¨æˆ·</h3>
            <form id="add-user-form" onsubmit="event.preventDefault(); addUser();">
                <div class="form-group">
                    <label>å·¥å·</label>
                    <input type="text" id="new-user-id" placeholder="ä¾‹å¦‚ï¼šFY2026001" required>
                </div>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="new-user-name" placeholder="è¯·è¾“å…¥å§“å" required>
                </div>
                <div class="form-group">
                    <label>ç§‘å®¤</label>
                    <select id="new-user-dept" required>
                        <option value="">è¯·é€‰æ‹©ç§‘å®¤...</option>
                        <option value="unit">é™¢é¢†å¯¼</option>
                        <option value="party-office">å…šå§”åŠã€è¡Œæ”¿åŠ</option>
                        <option value="conduct-office">è¡Œé£åŠ</option>
                        <option value="personnel">äººäº‹ç§‘</option>
                        <option value="finance">è´¢åŠ¡ç§‘</option>
                        <option value="medical-insurance">åŒ»ä¿ç§‘</option>
                        <option value="medical">åŒ»åŠ¡ç§‘</option>
                        <option value="nursing">æŠ¤ç†éƒ¨</option>
                        <option value="infection-control">æ„Ÿæ§ç§‘</option>
                        <option value="pharmacy">è¯å­¦éƒ¨</option>
                        <option value="health-care">ä¿å¥éƒ¨</option>
                        <option value="reform-office">åŒ»æ”¹åŠ</option>
                        <option value="logistics">åå‹¤ä¿éšœç§‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>èŒåŠ¡</label>
                    <input type="text" id="new-user-position" placeholder="ä¾‹å¦‚ï¼šä¸»ä»»åŒ»å¸ˆ" required>
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·è§’è‰²</label>
                    <select id="new-user-role">
                        <option value="staff">æ™®é€šå‘˜å·¥</option>
                        <option value="manager">ç§‘å®¤ç®¡ç†å‘˜</option>
                        <option value="admin">ç³»ç»Ÿç®¡ç†å‘˜</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æ·»åŠ ç”¨æˆ·</button>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘ç”¨æˆ·å¼¹çª— -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('edit-user-modal')">&times;</span>
            <h3>ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</h3>
            <form id="edit-user-form" onsubmit="event.preventDefault(); updateUser();">
                <input type="hidden" id="edit-user-id-hidden">
                <div class="form-group">
                    <label>å·¥å·</label>
                    <input type="text" id="edit-user-id" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="edit-user-name" required>
                </div>
                <div class="form-group">
                    <label>ç§‘å®¤</label>
                    <select id="edit-user-dept" required>
                        <option value="">è¯·é€‰æ‹©ç§‘å®¤...</option>
                        <option value="unit">é™¢é¢†å¯¼</option>
                        <option value="party-office">å…šå§”åŠã€è¡Œæ”¿åŠ</option>
                        <option value="conduct-office">è¡Œé£åŠ</option>
                        <option value="personnel">äººäº‹ç§‘</option>
                        <option value="finance">è´¢åŠ¡ç§‘</option>
                        <option value="medical-insurance">åŒ»ä¿ç§‘</option>
                        <option value="medical">åŒ»åŠ¡ç§‘</option>
                        <option value="nursing">æŠ¤ç†éƒ¨</option>
                        <option value="infection-control">æ„Ÿæ§ç§‘</option>
                        <option value="pharmacy">è¯å­¦éƒ¨</option>
                        <option value="health-care">ä¿å¥éƒ¨</option>
                        <option value="reform-office">åŒ»æ”¹åŠ</option>
                        <option value="logistics">åå‹¤ä¿éšœç§‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>èŒåŠ¡</label>
                    <input type="text" id="edit-user-position" required>
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·è§’è‰²</label>
                    <select id="edit-user-role">
                        <option value="staff">æ™®é€šå‘˜å·¥</option>
                        <option value="manager">ç§‘å®¤ç®¡ç†å‘˜</option>
                        <option value="admin">ç³»ç»Ÿç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è´¦å·çŠ¶æ€</label>
                    <select id="edit-user-status">
                        <option value="active">å¯ç”¨</option>
                        <option value="inactive">ç¦ç”¨</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <script>
        // ==================== ç³»ç»ŸçŠ¶æ€ç®¡ç† ====================
        let currentLevel = 'unit';
        let okrPairs = [];
        let okrIdCounter = 0;
        let currentUser = null;

        // æ•°æ®å­˜å‚¨
        let savedOKRs = {
            unit: [],
            dept: {},
            person: {}
        };

        // é»˜è®¤ç®¡ç†å‘˜è´¦å·
        const defaultAdmin = {
            id: 'admin',
            name: 'ç³»ç»Ÿç®¡ç†å‘˜',
            dept: 'admin',
            position: 'ç³»ç»Ÿç®¡ç†å‘˜',
            role: 'admin',
            password: 'admin123',
            status: 'active'
        };

        // åˆå§‹ç”¨æˆ·æ•°æ®
        let users = [
            { id: 'FY2026001', name: 'å¼ ä¸»ä»»', dept: 'obstetrics', position: 'ç§‘ä¸»ä»»', role: 'manager', status: 'active' },
            { id: 'FY2026002', name: 'æå‰¯ä¸»ä»»åŒ»å¸ˆ', dept: 'obstetrics', position: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', role: 'staff', status: 'active' },
            { id: 'FY2026003', name: 'åˆ˜ä¸»ä»»', dept: 'gynecology', position: 'ç§‘ä¸»ä»»', role: 'manager', status: 'active' },
            { id: 'FY2026004', name: 'å­™ä¸»ä»»', dept: 'pediatrics', position: 'ç§‘ä¸»ä»»', role: 'manager', status: 'active' },
            { id: 'FY2026005', name: 'é©¬ç§‘é•¿', dept: 'health-edu', position: 'ç§‘é•¿', role: 'manager', status: 'active' }
        ];

        // ç§‘å®¤äººå‘˜æ•°æ®
        const departmentPersons = {
            obstetrics: ['å¼ ä¸»ä»»', 'æå‰¯ä¸»ä»»åŒ»å¸ˆ'],
            gynecology: ['åˆ˜ä¸»ä»»'],
            pediatrics: ['å­™ä¸»ä»»'],
            'health-edu': ['é©¬ç§‘é•¿'],
            'maternal-health': [],
            'child-health': [],
            admin: []
        };

        // æ¨¡æ¿æ•°æ®
        const templates = {
            unit: [
                {
                    name: 'åŒ»ç–—æœåŠ¡è´¨é‡æå‡æ¨¡æ¿',
                    ors: [
                        {
                            text: 'æå‡å¦‡å¹¼å¥åº·æœåŠ¡æ°´å¹³ï¼Œæ‰“é€ åŒºåŸŸå†…æ ‡æ†å¦‡å¹¼ä¿å¥é™¢',
                            ks: ['é—¨è¯Šé‡è¾ƒå»å¹´åŒæœŸå¢é•¿15%', 'æ‚£è€…æ»¡æ„åº¦è¾¾åˆ°95%ä»¥ä¸Š', 'åŒ»ç–—äº‹æ•…å‘ç”Ÿç‡ä¸º0']
                        }
                    ]
                }
            ],
            dept: {
                obstetrics: [
                    {
                        name: 'äº§ç§‘å®‰å…¨è´¨é‡æ¨¡æ¿',
                        ors: [
                            {
                                text: 'ä¿éšœæ¯å©´å®‰å…¨ï¼Œæå‡äº§ç§‘æœåŠ¡è´¨é‡',
                                ks: ['å­•äº§å¦‡æ­»äº¡ç‡æ§åˆ¶åœ¨15/10ä¸‡ä»¥ä¸‹', 'å‰–å®«äº§ç‡æ§åˆ¶åœ¨35%ä»¥å†…', 'è‡ªç„¶åˆ†å¨©ç‡æå‡è‡³65%']
                            }
                        ]
                    }
                ],
                pediatrics: [
                    {
                        name: 'å„¿ç§‘æœåŠ¡èƒ½åŠ›æ¨¡æ¿',
                        ors: [
                            {
                                text: 'æå‡å„¿ç§‘è¯Šç–—æ°´å¹³ï¼Œä¼˜åŒ–æ‚£å„¿å°±åŒ»ä½“éªŒ',
                                ks: ['å„¿ç§‘é—¨è¯Šé‡å¢é•¿20%', 'å¹³å‡å€™è¯Šæ—¶é—´æ§åˆ¶åœ¨30åˆ†é’Ÿå†…', 'æ‚£å„¿å®¶å±æ»¡æ„åº¦è¾¾åˆ°96%']
                            }
                        ]
                    }
                ]
            },
            person: [
                {
                    name: 'åŒ»å¸ˆä¸ªäººå‘å±•æ¨¡æ¿',
                    ors: [
                        {
                            text: 'æå‡ä¸´åºŠæŠ€èƒ½ï¼Œä¸ºç§‘å®¤ç›®æ ‡åšè´¡çŒ®',
                            ks: ['å®Œæˆé—¨è¯Šè¯Šç–—é‡500äººæ¬¡', 'å‚ä¸ç§‘å®¤ç–‘éš¾ç—…ä¾‹è®¨è®º10æ¬¡', 'å‚åŠ ç»§ç»­æ•™è‚²å­¦ä¹ 20å­¦æ—¶']
                        }
                    ]
                }
            ]
        };

        // æ ¡éªŒè§„åˆ™é…ç½®
        const validationRules = {
            unit: {
                orMinLength: 10,
                orMaxLength: 50,
                kMinCount: 2,
                kMaxCount: 5,
                requiredKeywords: ['æå‡', 'æœåŠ¡', 'å¥åº·', 'ä¿éšœ'],
                requiredMetrics: ['ç‡', 'å¢é•¿', 'ä¸‹é™', 'è¦†ç›–']
            },
            dept: {
                orMinLength: 8,
                orMaxLength: 40,
                kMinCount: 2,
                kMaxCount: 4,
                requiredKeywords: ['æå‡', 'ä¼˜åŒ–', 'ä¿éšœ', 'å®Œæˆ'],
                requiredMetrics: ['ç‡', 'é‡', 'æ¬¡', '%']
            },
            person: {
                orMinLength: 6,
                orMaxLength: 30,
                kMinCount: 2,
                kMaxCount: 4,
                requiredKeywords: ['æå‡', 'å®Œæˆ', 'å­¦ä¹ ', 'å‚ä¸'],
                requiredMetrics: ['æ¬¡', 'äºº', '%', 'å­¦æ—¶']
            }
        };

        // ==================== ç™»å½•å’Œæƒé™ç®¡ç† ====================

        function handleLogin() {
            const userId = document.getElementById('login-id').value.trim();
            const password = document.getElementById('login-password').value;

            // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•
            if (userId === 'admin') {
                // ç®¡ç†å‘˜ç™»å½•
                const adminData = JSON.parse(localStorage.getItem('admin_password_data') || '{}');
                const adminPassword = adminData.password || 'admin123';

                if (password === adminPassword) {
                    currentUser = {...defaultAdmin, password: adminPassword};
                    loginSuccess();
                    return;
                } else {
                    alert('å¯†ç é”™è¯¯ï¼');
                    return;
                }
            }

            // æ£€æŸ¥æ™®é€šç”¨æˆ·ç™»å½•
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('å·¥å·ä¸å­˜åœ¨ï¼');
                return;
            }

            if (user.status === 'inactive') {
                alert('è¯¥è´¦å·å·²è¢«ç¦ç”¨ï¼');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·å¯†ç ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å¯†ç ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å¯†ç ï¼‰
            const userPassword = user.customPassword || '123456';
            if (password === userPassword) {
                currentUser = user;
                loginSuccess();
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        function loginSuccess() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-container').classList.add('active');
            adjustUIForRole(currentUser.role);
            loadDataFromStorage();
            updateWelcomeMessage();
            alert(`æ¬¢è¿å›æ¥ï¼Œ${currentUser.name}ï¼`);
        }

        function adjustUIForRole(role) {
            const levelBtns = document.querySelectorAll('.level-btn');
            levelBtns.forEach(btn => {
                btn.classList.remove('disabled');
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });

            if (role === 'staff') {
                setTimeout(() => switchLevel('person'), 100);
                levelBtns.forEach(btn => {
                    if (btn.dataset.level !== 'person') {
                        btn.classList.add('disabled');
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    }
                });
            } else if (role === 'manager') {
                setTimeout(() => switchLevel('dept'), 100);
                levelBtns.forEach(btn => {
                    if (btn.dataset.level === 'unit') {
                        btn.classList.add('disabled');
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    }
                });
            }

            const usersNavItem = document.querySelector('[data-section="users"]');
            if (usersNavItem) {
                usersNavItem.style.display = role === 'admin' ? 'block' : 'none';
            }
        }

        function updateWelcomeMessage() {
            const welcomeMessage = document.getElementById('welcome-message');
            const roleNames = {
                'admin': 'ç³»ç»Ÿç®¡ç†å‘˜',
                'manager': 'ç§‘å®¤ç®¡ç†å‘˜',
                'staff': 'æ™®é€šå‘˜å·¥'
            };
            const deptNames = {
                'admin': 'è¡Œæ”¿åŠå…¬å®¤', 'obstetrics': 'äº§ç§‘', 'gynecology': 'å¦‡ç§‘',
                'pediatrics': 'å„¿ç§‘', 'health-edu': 'å¥åº·æ•™è‚²ç§‘',
                'maternal-health': 'å­•äº§å¦‡ä¿å¥ç§‘', 'child-health': 'å„¿ç«¥ä¿å¥ç§‘'
            };
            welcomeMessage.textContent = `${currentUser.name} | ${roleNames[currentUser.role]} | ${deptNames[currentUser.dept]}`;
        }

        function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
            currentUser = null;
            document.getElementById('main-container').classList.remove('active');
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('login-id').value = '';
            document.getElementById('login-password').value = '';
        }

        // ==================== æ•°æ®æŒä¹…åŒ– ====================

        function saveDataToStorage() {
            try {
                const dataToSave = {
                    users: users,
                    savedOKRs: savedOKRs,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('okrSystemData', JSON.stringify(dataToSave));
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥ï¼š', error);
            }
        }

        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('okrSystemData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.users) {
                        users = parsedData.users;
                        if (!users.find(u => u.id === 'admin')) {
                            users.push(defaultAdmin);
                        }
                    }
                    if (parsedData.savedOKRs) {
                        savedOKRs = parsedData.savedOKRs;
                    }
                    console.log('æ•°æ®å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½');
                    renderUsers();
                    updateDepartmentPersonsFromUsers();
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼š', error);
            }
        }

        function clearLocalData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            localStorage.removeItem('okrSystemData');
            alert('æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼Œåˆ·æ–°é¡µé¢åå°†é‡æ–°åŠ è½½é»˜è®¤æ•°æ®');
            location.reload();
        }

        function exportData() {
            const dataToExport = {
                users: users,
                savedOKRs: savedOKRs,
                exportTime: new Date().toLocaleString()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `okr_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== OKRæ ¸å¿ƒåŠŸèƒ½ ====================

        function addOKRPair() {
            const pairId = ++okrIdCounter;
            const pair = {
                id: pairId,
                or: '',
                ks: ['', ''],
                validation: {
                    valid: false,
                    warnings: [],
                    errors: []
                }
            };
            okrPairs.push(pair);
            renderOKRPair(pair);
        }

        function renderOKRPair(pair) {
            const container = document.getElementById('okr-container');
            const pairElement = document.createElement('div');
            pairElement.className = 'okr-pair';
            pairElement.id = `okr-pair-${pair.id}`;
            pairElement.innerHTML = `
                <div class="pair-header">
                    <div class="pair-number">${pair.id}</div>
                    <div class="validation-status" id="validation-status-${pair.id}">å¾…æ ¡éªŒ</div>
                </div>
                <div class="form-group">
                    <label>ç›®æ ‡ (Objective)</label>
                    <input type="text" id="or-${pair.id}" placeholder="è¾“å…¥ç›®æ ‡ï¼Œä¾‹å¦‚ï¼šæå‡äº§ç§‘æœåŠ¡è´¨é‡" oninput="validatePair(${pair.id})">
                    <p class="help-text">ç›®æ ‡åº”ç®€æ´ã€é¼“èˆäººå¿ƒï¼Œé€šå¸¸8-50å­—</p>
                </div>
                <div class="form-group">
                    <label>å…³é”®ç»“æœ (Key Results)</label>
                    <div id="ks-container-${pair.id}">
                        ${pair.ks.map((k, index) => `
                            <div class="form-group">
                                <input type="text" id="k-${pair.id}-${index}" placeholder="å…³é”®ç»“æœ ${index + 1}" value="${k}" oninput="validatePair(${pair.id})">
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-secondary" onclick="addK(${pair.id})" style="font-size: 12px; padding: 8px 15px;">+ æ·»åŠ å…³é”®ç»“æœ</button>
                </div>
                <div class="feedback-box" id="feedback-${pair.id}" style="display: none;">
                    <div class="feedback-title" id="feedback-title-${pair.id}"></div>
                    <ul class="feedback-list" id="feedback-list-${pair.id}"></ul>
                </div>
                <button class="btn btn-secondary" onclick="removePair(${pair.id})" style="margin-top: 15px; font-size: 12px; background: #dc3545;">åˆ é™¤æ­¤ç»„åˆ</button>
            `;
            container.appendChild(pairElement);
        }

        function addK(pairId) {
            const pair = okrPairs.find(p => p.id === pairId);
            if (pair && pair.ks.length < 5) {
                pair.ks.push('');
                const ksContainer = document.getElementById(`ks-container-${pairId}`);
                const kIndex = pair.ks.length - 1;
                const kElement = document.createElement('div');
                kElement.className = 'form-group';
                kElement.innerHTML = `<input type="text" id="k-${pairId}-${kIndex}" placeholder="å…³é”®ç»“æœ ${kIndex + 1}" oninput="validatePair(${pairId})">`;
                ksContainer.appendChild(kElement);
            } else {
                alert('å…³é”®ç»“æœæœ€å¤šä¸èƒ½è¶…è¿‡5ä¸ª');
            }
        }

        function removePair(pairId) {
            okrPairs = okrPairs.filter(p => p.id !== pairId);
            document.getElementById(`okr-pair-${pairId}`).remove();
            if (okrPairs.length === 0) {
                addOKRPair();
            }
        }

        function validatePair(pairId) {
            const pair = okrPairs.find(p => p.id === pairId);
            if (!pair) return;

            const orInput = document.getElementById(`or-${pairId}`);
            pair.or = orInput.value;

            pair.ks = [];
            const kInputs = document.querySelectorAll(`#ks-container-${pairId} input`);
            kInputs.forEach((input, index) => {
                pair.ks[index] = input.value;
            });

            const rules = validationRules[currentLevel];
            const validation = { valid: true, warnings: [], errors: [] };

            // æ ¡éªŒç›®æ ‡
            if (!pair.or.trim()) {
                validation.errors.push('ç›®æ ‡ä¸èƒ½ä¸ºç©º');
                validation.valid = false;
            } else if (pair.or.length < rules.orMinLength) {
                validation.errors.push(`ç›®æ ‡å¤ªçŸ­ï¼Œè‡³å°‘éœ€è¦${rules.orMinLength}ä¸ªå­—`);
                validation.valid = false;
            } else if (pair.or.length > rules.orMaxLength) {
                validation.errors.push(`ç›®æ ‡å¤ªé•¿ï¼Œä¸èƒ½è¶…è¿‡${rules.orMaxLength}ä¸ªå­—`);
                validation.valid = false;
            } else {
                const hasKeyword = rules.requiredKeywords.some(keyword => pair.or.includes(keyword));
                if (!hasKeyword) {
                    validation.warnings.push('å»ºè®®åŒ…å«å…³é”®è¯ï¼š' + rules.requiredKeywords.join('ã€'));
                }
            }

            // æ ¡éªŒå…³é”®ç»“æœ
            const validKs = pair.ks.filter(k => k.trim());
            if (validKs.length < rules.kMinCount) {
                validation.errors.push(`è‡³å°‘éœ€è¦${rules.kMinCount}ä¸ªæœ‰æ•ˆå…³é”®ç»“æœ`);
                validation.valid = false;
            } else if (validKs.length > rules.kMaxCount) {
                validation.errors.push(`å…³é”®ç»“æœä¸èƒ½è¶…è¿‡${rules.kMaxCount}ä¸ª`);
                validation.valid = false;
            }

            // æ£€æŸ¥æ¯ä¸ªKRçš„é‡åŒ–æŒ‡æ ‡
            validKs.forEach((k, index) => {
                const hasMetric = rules.requiredMetrics.some(metric => k.includes(metric));
                if (!hasMetric) {
                    validation.warnings.push(`å…³é”®ç»“æœ${index + 1}ç¼ºå°‘é‡åŒ–æŒ‡æ ‡`);
                }
                if (!/\d/.test(k)) {
                    validation.warnings.push(`å…³é”®ç»“æœ${index + 1}ç¼ºå°‘å…·ä½“æ•°å­—`);
                }
            });

            // OKRå†²çªæ£€æµ‹
            const conflictResult = detectOKRConflicts(pairId, pair.or, validKs);
            if (conflictResult.hasConflict) {
                validation.errors.push(conflictResult.message);
                validation.valid = false;
            }

            pair.validation = validation;
            updatePairUI(pairId, validation);
        }

        function detectOKRConflicts(currentPairId, currentOr, currentKs) {
            const result = { hasConflict: false, message: '' };

            okrPairs.forEach(pair => {
                if (pair.id === currentPairId) return;

                const orSimilarity = calculateSimilarity(currentOr, pair.or);
                if (orSimilarity > 0.8) {
                    result.hasConflict = true;
                    result.message = `ç›®æ ‡ä¸å…¶ä»–OKRè¿‡äºç›¸ä¼¼ï¼Œè¯·é¿å…é‡å¤è®¾å®š`;
                    return;
                }

                currentKs.forEach(k1 => {
                    pair.ks.forEach(k2 => {
                        if (k2 && calculateSimilarity(k1, k2) > 0.85) {
                            result.hasConflict = true;
                            result.message = `å…³é”®ç»“æœä¸å…¶ä»–OKRé‡å¤`;
                        }
                    });
                });
            });

            return result;
        }

        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            const set1 = new Set(str1.split(''));
            const set2 = new Set(str2.split(''));
            const intersection = new Set([...set1].filter(x => set2.has(x)));
            const union = new Set([...set1, ...set2]);
            return intersection.size / union.size;
        }

        function updatePairUI(pairId, validation) {
            const pairElement = document.getElementById(`okr-pair-${pairId}`);
            const statusElement = document.getElementById(`validation-status-${pairId}`);
            const feedbackElement = document.getElementById(`feedback-${pairId}`);

            pairElement.classList.remove('valid', 'invalid', 'warning');
            if (validation.valid && validation.warnings.length === 0) {
                pairElement.classList.add('valid');
            } else if (!validation.valid) {
                pairElement.classList.add('invalid');
            } else {
                pairElement.classList.add('warning');
            }

            if (validation.valid && validation.warnings.length === 0) {
                statusElement.className = 'validation-status valid';
                statusElement.innerHTML = '<span>âœ“ å·²é€šè¿‡æ ¡éªŒ</span>';
            } else if (!validation.valid) {
                statusElement.className = 'validation-status invalid';
                statusElement.innerHTML = `<span>âœ— å­˜åœ¨é—®é¢˜ (${validation.errors.length})</span>`;
            } else {
                statusElement.className = 'validation-status warning';
                statusElement.innerHTML = `<span>âš  æœ‰å»ºè®® (${validation.warnings.length})</span>`;
            }

            if (validation.errors.length > 0 || validation.warnings.length > 0) {
                feedbackElement.style.display = 'block';
                const titleElement = document.getElementById(`feedback-title-${pairId}`);
                const listElement = document.getElementById(`feedback-list-${pairId}`);
                if (validation.errors.length > 0) {
                    feedbackElement.className = 'feedback-box invalid';
                    titleElement.innerHTML = '<span>âŒ å¿…é¡»ä¿®æ”¹çš„é—®é¢˜ï¼š</span>';
                    listElement.innerHTML = validation.errors.map(e => `<li>${e}</li>`).join('');
                } else {
                    feedbackElement.className = 'feedback-box warning';
                    titleElement.innerHTML = '<span>ğŸ’¡ ä¼˜åŒ–å»ºè®®ï¼š</span>';
                    listElement.innerHTML = validation.warnings.map(w => `<li>${w}</li>`).join('');
                }
            } else {
                feedbackElement.style.display = 'none';
            }
        }

        function validateAll() {
            okrPairs.forEach(pair => validatePair(pair.id));
            const allValid = okrPairs.every(p => p.validation.valid);
            alert(allValid ? 'âœ“ æ‰€æœ‰OKRå·²é€šè¿‡æ ¡éªŒï¼' : 'âœ— éƒ¨åˆ†OKRå­˜åœ¨é—®é¢˜ï¼Œè¯·æ ¹æ®åé¦ˆæ„è§ä¿®æ”¹');
        }

        function submitOKR() {
            okrPairs.forEach(pair => validatePair(pair.id));
            const invalidPairs = okrPairs.filter(p => !p.validation.valid);
            if (invalidPairs.length > 0) {
                alert(`è¿˜æœ‰ ${invalidPairs.length} ä¸ªOKRç»„åˆæœªé€šè¿‡æ ¡éªŒï¼Œè¯·ä¿®æ”¹åå†æäº¤`);
                return;
            }

            const validPairs = okrPairs.map(p => ({
                or: p.or,
                ks: p.ks.filter(k => k.trim())
            }));

            if (currentLevel === 'unit') {
                savedOKRs.unit = validPairs;
            } else if (currentLevel === 'dept') {
                const dept = document.getElementById('department-select').value;
                if (!dept) { alert('è¯·å…ˆé€‰æ‹©ç§‘å®¤'); return; }
                savedOKRs.dept[dept] = validPairs;
            } else if (currentLevel === 'person') {
                const dept = document.getElementById('department-select').value;
                const person = document.getElementById('person-select').value;
                if (!dept || !person) { alert('è¯·å…ˆé€‰æ‹©ç§‘å®¤å’Œäººå‘˜'); return; }
                if (!savedOKRs.person[dept]) { savedOKRs.person[dept] = {}; }
                savedOKRs.person[dept][person] = validPairs;
            }

            saveDataToStorage();
            document.getElementById('success-modal').classList.add('active');
        }

        function resetForm() {
            okrPairs = [];
            document.getElementById('okr-container').innerHTML = '';
            addOKRPair();
        }

        // ==================== ç”¨æˆ·ç®¡ç†åŠŸèƒ½ ====================

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            users.forEach(user => {
                const roleNames = {
                    'admin': 'ç³»ç»Ÿç®¡ç†å‘˜',
                    'manager': 'ç§‘å®¤ç®¡ç†å‘˜',
                    'staff': 'æ™®é€šå‘˜å·¥'
                };
                const deptNames = {
                    'unit': 'é™¢é¢†å¯¼',
                    'party-office': 'å…šå§”åŠã€è¡Œæ”¿åŠ',
                    'conduct-office': 'è¡Œé£åŠ',
                    'personnel': 'äººäº‹ç§‘',
                    'finance': 'è´¢åŠ¡ç§‘',
                    'medical-insurance': 'åŒ»ä¿ç§‘',
                    'medical': 'åŒ»åŠ¡ç§‘',
                    'nursing': 'æŠ¤ç†éƒ¨',
                    'infection-control': 'æ„Ÿæ§ç§‘',
                    'pharmacy': 'è¯å­¦éƒ¨',
                    'health-care': 'ä¿å¥éƒ¨',
                    'reform-office': 'åŒ»æ”¹åŠ',
                    'logistics': 'åå‹¤ä¿éšœç§‘'
                };

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${deptNames[user.dept] || user.dept}</td>
                    <td>${user.position}</td>
                    <td>${roleNames[user.role]}</td>
                    <td><span class="status-badge ${user.status}">${user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="showEditUserModal('${user.id}')" style="font-size: 12px; padding: 5px 10px;">ç¼–è¾‘</button>
                        ${user.id !== 'admin' ? `<button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 12px; padding: 5px 10px;">åˆ é™¤</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterUsers() {
            const searchValue = document.getElementById('user-search').value.toLowerCase();
            const deptFilter = document.getElementById('user-dept-filter').value;

            const filteredUsers = users.filter(user => {
                const matchSearch = !searchValue || user.name.toLowerCase().includes(searchValue) ||
                    user.id.toLowerCase().includes(searchValue);
                const matchDept = !deptFilter || user.dept === deptFilter;
                return matchSearch && matchDept;
            });

            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            const roleNames = { 'admin': 'ç³»ç»Ÿç®¡ç†å‘˜', 'manager': 'ç§‘å®¤ç®¡ç†å‘˜', 'staff': 'æ™®é€šå‘˜å·¥' };
            const deptNames = {
                'unit': 'é™¢é¢†å¯¼',
                'party-office': 'å…šå§”åŠã€è¡Œæ”¿åŠ',
                'conduct-office': 'è¡Œé£åŠ',
                'personnel': 'äººäº‹ç§‘',
                'finance': 'è´¢åŠ¡ç§‘',
                'medical-insurance': 'åŒ»ä¿ç§‘',
                'medical': 'åŒ»åŠ¡ç§‘',
                'nursing': 'æŠ¤ç†éƒ¨',
                'infection-control': 'æ„Ÿæ§ç§‘',
                'pharmacy': 'è¯å­¦éƒ¨',
                'health-care': 'ä¿å¥éƒ¨',
                'reform-office': 'åŒ»æ”¹åŠ',
                'logistics': 'åå‹¤ä¿éšœç§‘'
            };

            filteredUsers.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${deptNames[user.dept] || user.dept}</td>
                    <td>${user.position}</td>
                    <td>${roleNames[user.role]}</td>
                    <td><span class="status-badge ${user.status}">${user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="showEditUserModal('${user.id}')" style="font-size: 12px; padding: 5px 10px;">ç¼–è¾‘</button>
                        ${user.id !== 'admin' ? `<button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="font-size: 12px; padding: 5px 10px;">åˆ é™¤</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showAddUserModal() {
            document.getElementById('add-user-modal').classList.add('active');
            document.getElementById('add-user-form').reset();
        }

        function addUser() {
            const newUser = {
                id: document.getElementById('new-user-id').value.trim(),
                name: document.getElementById('new-user-name').value.trim(),
                dept: document.getElementById('new-user-dept').value,
                position: document.getElementById('new-user-position').value.trim(),
                role: document.getElementById('new-user-role').value,
                status: 'active'
            };

            if (users.some(u => u.id === newUser.id)) {
                alert('å·¥å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–å·¥å·');
                return;
            }

            users.push(newUser);
            renderUsers();
            updateDepartmentPersonsFromUsers();
            saveDataToStorage();
            closeModal('add-user-modal');
            alert('ç”¨æˆ·æ·»åŠ æˆåŠŸï¼');
        }

        function showEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('edit-user-id-hidden').value = user.id;
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-dept').value = user.dept;
            document.getElementById('edit-user-position').value = user.position;
            document.getElementById('edit-user-role').value = user.role;
            document.getElementById('edit-user-status').value = user.status;

            document.getElementById('edit-user-modal').classList.add('active');
        }

        function updateUser() {
            const userId = document.getElementById('edit-user-id-hidden').value;
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;

            users[userIndex] = {
                id: userId,
                name: document.getElementById('edit-user-name').value.trim(),
                dept: document.getElementById('edit-user-dept').value,
                position: document.getElementById('edit-user-position').value.trim(),
                role: document.getElementById('edit-user-role').value,
                status: document.getElementById('edit-user-status').value
            };

            renderUsers();
            updateDepartmentPersonsFromUsers();
            saveDataToStorage();
            closeModal('edit-user-modal');
            alert('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
        }

        function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
            users = users.filter(u => u.id !== userId);
            renderUsers();
            updateDepartmentPersonsFromUsers();
            saveDataToStorage();
            alert('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼');
        }

        function updateDepartmentPersonsFromUsers() {
            for (const dept in departmentPersons) {
                departmentPersons[dept] = users
                    .filter(user => user.dept === dept)
                    .map(user => user.name);
            }
        }

        // ==================== æ¨¡æ¿å’Œç›®æ ‡æ ‘åŠŸèƒ½ ====================

        function loadTemplates() {
            const container = document.getElementById('template-container');
            container.innerHTML = '';

            const currentTemplates = currentLevel === 'unit' ?
                templates.unit :
                (currentLevel === 'dept' ?
                    (templates.dept[document.getElementById('department-select').value] || []) :
                    templates.person
                );

            if (currentTemplates.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; grid-column: 1/-1;">æš‚æ— æ¨¡æ¿ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºOKR</p>';
                return;
            }

            currentTemplates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `
                    <h4>${template.name}</h4>
                    ${template.ors.map(or => `
                        <div class="okr-item">
                            <strong>ç›®æ ‡ï¼š</strong>${or.text}
                            ${or.ks.map(k => `<div style="margin-left: 15px; margin-top: 5px;"><strong>KRï¼š</strong>${k}</div>`).join('')}
                        </div>
                    `).join('')}
                `;
                card.onclick = () => applyTemplate(template);
                container.appendChild(card);
            });
        }

        function showTemplates() {
            switchSection('templates');
            loadTemplates();
        }

        function applyTemplate(template) {
            okrPairs = [];
            document.getElementById('okr-container').innerHTML = '';

            template.ors.forEach(or => {
                const pairId = ++okrIdCounter;
                const pair = {
                    id: pairId,
                    or: or.text,
                    ks: or.ks,
                    validation: { valid: true, warnings: [], errors: [] }
                };
                okrPairs.push(pair);
                renderOKRPair(pair);

                document.getElementById(`or-${pairId}`).value = or.text;
                or.ks.forEach((k, index) => {
                    const kInput = document.getElementById(`k-${pairId}-${index}`);
                    if (kInput) {
                        kInput.value = k;
                    } else {
                        addK(pairId);
                        document.getElementById(`k-${pairId}-${index}`).value = k;
                    }
                });
            });

            switchSection('create');
            validateAll();
        }

        function renderOKRTree() {
            const treeContainer = document.getElementById('okr-tree');
            treeContainer.innerHTML = '';

            let totalOrs = 0, totalKs = 0, validCount = 0, totalCount = 0;

            const deptNames = {
                'admin': 'è¡Œæ”¿åŠå…¬å®¤', 'obstetrics': 'äº§ç§‘', 'gynecology': 'å¦‡ç§‘',
                'pediatrics': 'å„¿ç§‘', 'health-edu': 'å¥åº·æ•™è‚²ç§‘',
                'maternal-health': 'å­•äº§å¦‡ä¿å¥ç§‘', 'child-health': 'å„¿ç«¥ä¿å¥ç§‘'
            };

            if (savedOKRs.unit.length > 0) {
                totalOrs += savedOKRs.unit.length;
                savedOKRs.unit.forEach(or => { totalKs += or.ks.length; totalCount++; validCount++; });

                const unitNode = document.createElement('div');
                unitNode.className = 'tree-node level-unit';
                unitNode.innerHTML = `
                    <h4><span>çŸ³é˜¡å¿å¦‡å¹¼ä¿å¥é™¢</span><span class="tag">å•ä½å±‚é¢</span></h4>
                    ${savedOKRs.unit.map(or => `
                        <div class="or-item">
                            <strong>Oï¼š</strong>${or.or}
                            ${or.ks.map(k => `<div class="k-item"><strong>KRï¼š</strong>${k}</div>`).join('')}
                        </div>
                    `).join('')}
                `;
                treeContainer.appendChild(unitNode);
            }

            for (const dept in savedOKRs.dept) {
                if (savedOKRs.dept[dept].length > 0) {
                    totalOrs += savedOKRs.dept[dept].length;
                    savedOKRs.dept[dept].forEach(or => { totalKs += or.ks.length; totalCount++; validCount++; });

                    const deptNode = document.createElement('div');
                    deptNode.className = 'tree-node level-dept';
                    deptNode.innerHTML = `
                        <h4><span>${deptNames[dept] || dept}</span><span class="tag">ç§‘å®¤å±‚é¢</span></h4>
                        ${savedOKRs.dept[dept].map(or => `
                            <div class="or-item">
                                <strong>Oï¼š</strong>${or.or}
                                ${or.ks.map(k => `<div class="k-item"><strong>KRï¼š</strong>${k}</div>`).join('')}
                            </div>
                        `).join('')}
                    `;
                    treeContainer.appendChild(deptNode);
                }
            }

            for (const dept in savedOKRs.person) {
                for (const person in savedOKRs.person[dept]) {
                    if (savedOKRs.person[dept][person].length > 0) {
                        totalOrs += savedOKRs.person[dept][person].length;
                        savedOKRs.person[dept][person].forEach(or => { totalKs += or.ks.length; totalCount++; validCount++; });

                        const personNode = document.createElement('div');
                        personNode.className = 'tree-node level-person';
                        personNode.innerHTML = `
                            <h4><span>${person} (${deptNames[dept] || dept})</span><span class="tag">ä¸ªäººå±‚é¢</span></h4>
                            ${savedOKRs.person[dept][person].map(or => `
                                <div class="or-item">
                                    <strong>Oï¼š</strong>${or.or}
                                    ${or.ks.map(k => `<div class="k-item"><strong>KRï¼š</strong>${k}</div>`).join('')}
                                </div>
                            `).join('')}
                        `;
                        treeContainer.appendChild(personNode);
                    }
                }
            }

            document.getElementById('total-ors').textContent = totalOrs;
            document.getElementById('total-ks').textContent = totalKs;
            document.getElementById('valid-rate').textContent = totalCount > 0 ? Math.round((validCount / totalCount) * 100) + '%' : '0%';

            if (totalOrs === 0) {
                treeContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æš‚æ— OKRæ•°æ®ï¼Œè¯·å…ˆåœ¨"OKRæ‹Ÿå®š"é¡µé¢åˆ›å»º</p>';
            }
        }

        // ==================== ç•Œé¢äº¤äº’ ====================

        function switchSection(sectionName) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${sectionName}-section`).classList.add('active');

            if (sectionName === 'tree') {
                renderOKRTree();
            }
        }

        function switchLevel(level) {
            const levelBtn = document.querySelector(`[data-level="${level}"]`);
            if (levelBtn.classList.contains('disabled')) {
                alert('æ‚¨æ²¡æœ‰æƒé™æ“ä½œæ­¤å±‚çº§ï¼');
                return;
            }

            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            levelBtn.classList.add('active');

            document.getElementById('dept-select-group').classList.toggle('active', level === 'dept' || level === 'person');
            document.getElementById('person-select-group').classList.toggle('active', level === 'person');

            document.getElementById('okr-container').innerHTML = '';
            okrPairs = [];
            addOKRPair();
        }

        function updatePersonSelect(deptValue) {
            const personSelect = document.getElementById('person-select');
            personSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äººå‘˜...</option>';

            if (deptValue && departmentPersons[deptValue]) {
                departmentPersons[deptValue].forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    personSelect.appendChild(option);
                });
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ==================== å¯†ç ç®¡ç†åŠŸèƒ½ ====================

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('active');
        }

        // æ˜¾ç¤ºæ‰¾å›å¯†ç æ¨¡æ€æ¡†
        function showForgotPasswordModal() {
            document.getElementById('forgot-password-modal').classList.add('active');
        }

        // å¤„ç†ä¿®æ”¹å¯†ç 
        function handleChangePassword() {
            const userId = document.getElementById('change-id').value.trim();
            const oldPassword = document.getElementById('change-old-password').value;
            const newPassword = document.getElementById('change-new-password').value;
            const confirmPassword = document.getElementById('change-confirm-password').value;

            // éªŒè¯è¾“å…¥
            if (!userId) {
                alert('è¯·è¾“å…¥å·¥å·ï¼');
                return;
            }
            if (!oldPassword) {
                alert('è¯·è¾“å…¥åŸå¯†ç ï¼');
                return;
            }
            if (!newPassword) {
                alert('è¯·è¾“å…¥æ–°å¯†ç ï¼');
                return;
            }
            if (!confirmPassword) {
                alert('è¯·ç¡®è®¤æ–°å¯†ç ï¼');
                return;
            }
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }
            if (newPassword === oldPassword) {
                alert('æ–°å¯†ç ä¸èƒ½ä¸åŸå¯†ç ç›¸åŒï¼');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            // ç®¡ç†å‘˜ä¿®æ”¹å¯†ç 
            if (userId === 'admin') {
                const adminData = JSON.parse(localStorage.getItem('admin_password_data') || '{}');
                const currentPassword = adminData.password || 'admin123';

                if (oldPassword !== currentPassword) {
                    alert('åŸå¯†ç é”™è¯¯ï¼');
                    return;
                }

                adminData.password = newPassword;
                adminData.lastModified = new Date().toISOString();
                localStorage.setItem('admin_password_data', JSON.stringify(adminData));

                alert('ç®¡ç†å‘˜å¯†ç ä¿®æ”¹æˆåŠŸï¼');
                closeModal('change-password-modal');
                document.getElementById('change-id').value = '';
                document.getElementById('change-old-password').value = '';
                document.getElementById('change-new-password').value = '';
                document.getElementById('change-confirm-password').value = '';
                return;
            }

            // æ™®é€šç”¨æˆ·ä¿®æ”¹å¯†ç 
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('å·¥å·ä¸å­˜åœ¨ï¼');
                return;
            }

            const currentPassword = user.customPassword || '123456';
            if (oldPassword !== currentPassword) {
                alert('åŸå¯†ç é”™è¯¯ï¼');
                return;
            }

            user.customPassword = newPassword;
            saveUsersToStorage();

            alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            closeModal('change-password-modal');
            document.getElementById('change-id').value = '';
            document.getElementById('change-old-password').value = '';
            document.getElementById('change-new-password').value = '';
            document.getElementById('change-confirm-password').value = '';
        }

        // å¤„ç†æ‰¾å›å¯†ç ï¼ˆé‡ç½®å¯†ç ï¼‰
        function handleForgotPassword() {
            const userId = document.getElementById('forgot-id').value.trim();
            const userName = document.getElementById('forgot-name').value.trim();
            const newPassword = document.getElementById('forgot-new-password').value;
            const confirmPassword = document.getElementById('forgot-confirm-password').value;

            // éªŒè¯è¾“å…¥
            if (!userId) {
                alert('è¯·è¾“å…¥å·¥å·ï¼');
                return;
            }
            if (!userName) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            if (!newPassword) {
                alert('è¯·è¾“å…¥æ–°å¯†ç ï¼');
                return;
            }
            if (!confirmPassword) {
                alert('è¯·ç¡®è®¤æ–°å¯†ç ï¼');
                return;
            }
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            // ç®¡ç†å‘˜æ‰¾å›å¯†ç ï¼ˆéœ€è¦ç‰¹æ®ŠéªŒè¯ï¼‰
            if (userId === 'admin') {
                alert('ç®¡ç†å‘˜å¯†ç è¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜é‡ç½®ï¼');
                return;
            }

            // éªŒè¯ç”¨æˆ·èº«ä»½
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('å·¥å·ä¸å­˜åœ¨ï¼');
                return;
            }

            if (user.name !== userName) {
                alert('å·¥å·ä¸å§“åä¸åŒ¹é…ï¼');
                return;
            }

            // é‡ç½®å¯†ç 
            user.customPassword = newPassword;
            saveUsersToStorage();

            alert('å¯†ç é‡ç½®æˆåŠŸï¼è¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•ã€‚');
            closeModal('forgot-password-modal');
            document.getElementById('forgot-id').value = '';
            document.getElementById('forgot-name').value = '';
            document.getElementById('forgot-new-password').value = '';
            document.getElementById('forgot-confirm-password').value = '';
        }

        // ==================== åˆå§‹åŒ– ====================

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    switchSection(this.dataset.section);
                });
            });

            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchLevel(this.dataset.level);
                });
            });

            document.getElementById('department-select').addEventListener('change', function() {
                updatePersonSelect(this.value);
            });

            addOKRPair();
            loadTemplates();
            renderUsers();
            updateDepartmentPersonsFromUsers();
        });
    </script>
</body>
</html>